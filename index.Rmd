---
title: "Crime Analysis"
author: "Eric Born"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(plotly)
library(corrplot)

# read the csv file into R
dat <- read.csv(file='F:/Code projects/BU/555 - analysis and vis/Final/SD-crime.csv', sep = ',')

# Remove columns 2-6, 8-9, 11-12, 15, 16 which are not being used during this analysis
crime.df <- dat[, c(1,7,10,13,14)]

# create a new column containing just the year
crime.df$year <- substr(crime.df$month, 5, 6)

# summary stats for data
full.stats <- data.frame('Measure' = c('Violent Crime', 'Burglary', 'Thefts', 
                                       'Vehicle Theft'),
                         'Min' = c(summary(crime.df$Total.Violent.Crime)[[1]],
                                   summary(crime.df$Total.Burglary)[[1]],
                                   summary(crime.df$Total.Thefts)[[1]],
                                   summary(crime.df$Motor.Vehicle.Theft)[[1]]),
                         
                         'q1' = c(summary(crime.df$Total.Violent.Crime)[[2]],
                                  summary(crime.df$Total.Burglary)[[2]],
                                     summary(crime.df$Total.Thefts)[[2]],
                                  summary(crime.df$Motor.Vehicle.Theft)[[2]]),
                         
                         'Median' = c(summary(crime.df$Total.Violent.Crime)[[3]],
                                      summary(crime.df$Total.Burglary)[[3]],
                                      summary(crime.df$Total.Thefts)[[3]],
                                      summary(crime.df$Motor.Vehicle.Theft)[[3]]),
                         
                         'Mean' = c(summary(crime.df$Total.Violent.Crime)[[4]],
                                    summary(crime.df$Total.Burglary)[[4]],
                                    summary(crime.df$Total.Thefts)[[4]],
                                    summary(crime.df$Motor.Vehicle.Theft)[[4]]),
                         
                         'q3' = c(summary(crime.df$Total.Violent.Crime)[[5]],
                                  summary(crime.df$Total.Burglary)[[5]],
                                  summary(crime.df$Total.Thefts)[[5]],
                                  summary(crime.df$Motor.Vehicle.Theft)[[5]]),
                         
                         'Max' = c(summary(crime.df$Total.Violent.Crime)[[6]],
                                   summary(crime.df$Total.Burglary)[[6]],
                                   summary(crime.df$Total.Thefts)[[6]],
                                   summary(crime.df$Motor.Vehicle.Theft)[[6]]))

# reset factors to order by Measure column
full.stats$Measure <- factor(full.stats$Measure, 
                             levels = c(as.character(full.stats$Measure)))

# Convert factors to character
full.stats$Measure <- as.character(full.stats$Measure)

# create table for summary stats
summary.stat.table <- plot_ly(
  type = 'table',
  height = 180,
  #width = 700,
  columnwidth = c(25, 15, 15, 15, 15),
  header = list(
    values = c('Measure', 'Min', '1st Q', 'Median', 'Mean', '3rd Q', 'Max'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(full.stats$Measure, full.stats$Min, full.stats$q1, full.stats$Median, 
                   round(full.stats$Mean,1), full.stats$q3, full.stats$Max),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# create a new column to track changes from month to month
for (row in 1:nrow(crime.df)){
  if (is.na(crime.df$Total.Violent.Crime[row + 1]
            - crime.df$Total.Violent.Crime[row])) {
  } 
  else {
    crime.df$violent.change[row + 1] <- (crime.df$Total.Violent.Crime[row + 1]
                                         - crime.df$Total.Violent.Crime[row])
    crime.df$burglary.change[row + 1] <- (crime.df$Total.Burglary[row  + 1]
                                          - crime.df$Total.Burglary[row])
    crime.df$thefts.change[row + 1] <- (crime.df$Total.Thefts[row + 1]
                                        - crime.df$Total.Thefts[row])
    crime.df$vehicle.change[row + 1] <- (crime.df$Motor.Vehicle.Theft[row + 1]
                                         - crime.df$Motor.Vehicle.Theft[row])
  }
}

# create a dataframe containing only the monthly changes
crime.change <- crime.df[, c(7:10)]

# summary stats for data
change.stats <- data.frame('Measure' = c('Violent Crime', 'Burglary', 'Thefts', 
                                         'Vehicle Theft'),
                           'Min' = c(summary(crime.change$violent.change)[[1]],
                                     summary(crime.change$burglary.change)[[1]],
                                     summary(crime.change$thefts.change)[[1]],
                                     summary(crime.change$vehicle.change)[[1]]),
                           
                           'q1' = c(summary(crime.change$violent.change)[[2]],
                                    summary(crime.change$burglary.change)[[2]],
                                    summary(crime.change$thefts.change)[[2]],
                                    summary(crime.change$vehicle.change)[[2]]),
                           
                           'Median' = c(summary(crime.change$violent.change)[[3]],
                                        summary(crime.change$burglary.change)[[3]],
                                        summary(crime.change$thefts.change)[[3]],
                                        summary(crime.change$vehicle.change)[[3]]),
                           
                           'Mean' = c(summary(crime.change$violent.change)[[4]],
                                      summary(crime.change$burglary.change)[[4]],
                                      summary(crime.change$thefts.change)[[4]],
                                      summary(crime.change$vehicle.change)[[4]]),
                           
                           'q3' = c(summary(crime.change$violent.change)[[5]],
                                    summary(crime.change$burglary.change)[[5]],
                                    summary(crime.change$thefts.change)[[5]],
                                    summary(crime.change$vehicle.change)[[5]]),
                           
                           'Max' = c(summary(crime.change$violent.change)[[6]],
                                     summary(crime.change$burglary.change)[[6]],
                                     summary(crime.change$thefts.change)[[6]],
                                     summary(crime.change$vehicle.change)[[6]]))

# reset factors to order by Measure column
change.stats$Measure <- factor(change.stats$Measure, 
                             levels = c(as.character(full.stats$Measure)))

# Convert factors to character
change.stats$Measure <- as.character(change.stats$Measure)

# create change summary table
summary.change.table <- plot_ly(
  type = 'table',
  height = 180,
  #width = 700,
  columnwidth = c(25, 15, 15, 15, 15),
  header = list(
    values = c('Measure', 'Min', '1st Q', 'Median', 'Mean', '3rd Q', 'Max'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(change.stats$Measure, change.stats$Min, change.stats$q1, change.stats$Median, 
                   round(change.stats$Mean,1), change.stats$q3, change.stats$Max),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# create sums by year for each of the main categories
crime.year <- setNames(aggregate(list(crime.df$Total.Violent.Crime, crime.df$Total.Burglary, 
                                      crime.df$Total.Thefts, crime.df$Motor.Vehicle.Theft), 
                                 by=crime.df['year'], sum), c('year','violent', 'burglary', 'theft', 'vehicle'))

# create new columns to track yearly changes
crime.year$violent.change = 0
crime.year$burglary.change = 0
crime.year$thefts.change = 0
crime.year$vehicle.change = 0

# create new columns to track yearly percent changes
crime.year$violent.pct = 0
crime.year$burglary.pct = 0
crime.year$thefts.pct = 0
crime.year$vehicle.pct = 0

# create a new column to track changes from month to month
# calculate the amount change between years
for (row in 1:nrow(crime.year)){
  if (is.na(crime.year$violent[row + 1]
            - crime.year$violent[row])) {
  }   
  else {
    crime.year$violent.pct[row + 1] <- ((crime.year$violent[row + 1]
                                        / crime.year$violent[row]) * 100) - 100
    crime.year$violent.change[row + 1] <- (crime.year$violent[row + 1]
                                           - crime.year$violent[row])
    
    crime.year$burglary.pct[row + 1] <- ((crime.year$burglary[row + 1]
                                         / crime.year$burglary[row]) * 100) - 100
    crime.year$burglary.change[row + 1] <- (crime.year$burglary[row + 1]
                                            - crime.year$burglary[row])
    
    crime.year$thefts.pct[row + 1] <- ((crime.year$theft[row + 1]
                                       / crime.year$theft[row])* 100) - 100
    crime.year$thefts.change[row + 1] <- (crime.year$theft[row + 1]
                                          - crime.year$theft[row])
    crime.year$vehicle.pct[row + 1] <- ((crime.year$vehicle[row + 1]
                                        / crime.year$vehicle[row]) * 100) - 100
    crime.year$vehicle.change[row + 1] <- (crime.year$vehicle[row + 1]
                                           - crime.year$vehicle[row])
  }
}

# Percentage change table from 2008 to 2018
percent.change.table <- plot_ly(
  type = 'table',
  height = 115,
  columnwidth = c(10, 10, 10, 10),
  header = list(
    values = c('Violent Crime', 'Burglary', 'Theft', 'Vehicle Theft'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(paste(round((((tail(crime.year$violent, 1) / crime.year$violent[1]) - 1)*100), 2),'%'),
                   paste(round((((tail(crime.year$burglary, 1) / crime.year$burglary[1]) - 1)*100), 2),'%'),
                   paste(round((((tail(crime.year$theft, 1) / crime.year$theft[1]) - 1)*100), 2),'%'),
                   paste(round((((tail(crime.year$vehicle, 1) / crime.year$vehicle[1]) - 1)*100), 2),'%')),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# prepends 20 to each year so its the full year, 2008 instead of 08
for(row in 1:nrow(crime.year)){
  crime.year[[1]][row] <- paste('20',crime.year[[1]][row], sep='')
}

# yearly totals
yearly.totals.table <- plot_ly(
  type = 'table',
  height = 320,
  width = 700,
  header = list(
    values = c('Year','Violent Crime', 'Burglary', 'Theft', 'Vehicle Theft'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(crime.year$year, crime.year$violent, crime.year$burglary, 
                   crime.year$theft, crime.year$vehicle),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# summary of change by year
change.by.year <- data.frame(rbind(summary(crime.year[-1,6]), summary(crime.year[-1,7]),
                                   summary(crime.year[-1,8]), summary(crime.year[-1,9])))

# Create column with measure names
change.by.year$measure <- c('Violent Crime', 'Burglary', 'Thefts', 'Vehicle Theft')

# summary of change by year
change.by.year.pct <- data.frame(rbind(summary(crime.year[-1,10]), summary(crime.year[-1,11]),
                                       summary(crime.year[-1,12]), summary(crime.year[-1,13])))

# Create column with measure names
change.by.year.pct$measure <- c('Violent Crime %', 'Burglary %', 'Thefts %', 'Vehicle Theft %')

# create yearly change summary table
yearly.change.table <- plot_ly(
  type = 'table',
  height = 180,
  #width = 700,
  columnwidth = c(25, 15, 15, 15, 15, 15, 15),
  header = list(
    values = c('Measure', 'Min', '1st Q', 'Median', 'Mean', '3rd Q', 'Max'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(change.by.year$measure, round(change.by.year$Min,2), round(change.by.year$X1st.Qu.,2), 
                   round(change.by.year$Median,2),round(change.by.year$Mean,2), 
                   round(change.by.year$X3rd.Qu.,2), round(change.by.year$Max,2)),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# Output summary of changes by year
yearly.change.table


# create yearly change summary table
yearly.change.pct.table <- plot_ly(
  type = 'table',
  height = 180,
  #width = 700,
  columnwidth = c(25, 15, 15, 15, 15, 15, 15),
  header = list(
    values = c('Measure', 'Min', '1st Q', 'Median', 'Mean', '3rd Q', 'Max'),
    line = list(width = 1, color = 'black'),
    fill = list(color = c('#1f77b4', '#1f77b4')),
    font = list(famile = 'Arial', size = 14, color = 'white')
  ),
  cells = list(
    values = rbind(change.by.year.pct$measure, 
                   paste(round(change.by.year.pct$Min,2),'%', sep=''),
                   paste(round(change.by.year.pct$X1st.Qu.,2),'%', sep=''),
                   paste(round(change.by.year.pct$Median,2),'%', sep=''),
                   paste(round(change.by.year.pct$Mean,2),'%', sep=''),
                   paste(round(change.by.year.pct$X3rd.Qu.,2),'%', sep=''),
                   paste(round(change.by.year.pct$Max,2),'%', sep='')),
    align = c('center'),
    line = list(width = 1, color = 'black')
  ))

# setup correlations beteen each category
cor.matrix <- cor(crime.df[, c(2:5)])
```

## Overview

Utilizing R, I performed a study on the overall crime levels to gain an understanding if there were any correlations between the total number of violent crimes, burglaries, thefts and vehicle thefts and to compare them over time to see if they have remained the same.

The data being used was from the San Diego Automated Regional Justice Information System (ARJIS) and contains the following columns: Murder, Rape, Armed Robbery, Strong Arm Robbery, Aggravated Assault, Total Violent Crime, Residential Burglary, Non-Residential Burglary, Total Burglary, Theft >= $400, Theft < $400, Total Thefts, Motor Vehicle Theft, Total Property Crime and Crime Index.

This data is presented as counts of occurrences by month from January 2008 to present day.

I chose to eliminate each of the crime subcategories and instead focus on the total number of violent crimes, burglaries, thefts and vehicle thefts along with the month they occurred, for a total of five columns.

Total Violent Crime equals the sum of murders, rapes, robberies, and aggravated assaults. Total Burglary equals the sum of residential and non-residential burglaries. Total Thefts equals the sum of thefts >= $400 and thefts < $400.

There are 132 total observations, one per month for 11 years.

The original data can be found here: http://crimestats.arjis.org/default.aspx

### Summary by Category

Here the five number summary is showing the occurrences per month by category. We can see that on average, theft occurs three to four times more often than the any of the other categories of crime and that the other three categories happen at close to the same frequency as each other.

```{r echo=FALSE}
# Plot summary table
summary.stat.table
```

### Summary of change by month

To study the change over time, I first calculated the change per category from one month to the next and then ran a summary on that data. From the summary you can see that the minimum and maximum, which is the measurement of the decrease or increase in total occurences from one month to the next, were close to the same for violent crime, and theft, but the largest decrease for burglary was 79 greater than the maximum increase, 303 compared to 224 and it was the opposite for vehicle theft, 423 as the highest increase versus 382 as the lowest decrease.

```{r echo=FALSE}
# Plot summary table
summary.change.table
```

### Yearly Totals

Total occurances by category from 2008 to 2018. There are little upticks here and there, but overall all of the categories had a decrease from 2008 to 2018. Lets look a little closer at the exact percent of change.

```{r echo=FALSE}
# yearly totals
yearly.totals.table
```

### Percent change from 2008 to 2018

When observing the difference in total events in each category from 2008 to 2018, we can see that vehicle theft fell the greatest at 52%, followed by burglary at 51.4%, theft at 18.64 and violent crime at 11.52%

```{r echo=FALSE}
# Percentage change table from 2008 to 2018
percent.change.table
```

### Summary of changes by year
Studying the changes by year shows that the mean value of each category is on the decline as we previously saw. Vehicle theft and burglary had the most significant average reduction 1025 and 864 yearly instances respectively. 

```{r echo=FALSE}
# Output summary of changes by year
yearly.change.table
```

### Percent changes by year
Since the raw numbers can be difficult to compare, lets look at the data as percentages. Again we see that Vehicle theft and burglary had the greatest average decline at 6.31% and 6.65%. Vehicle theft had the widest spread at just over 40%, dropping over 30% one year, but also climbing 11% on a different year. Violent crime had the least movement with its min/max falling 16% apart and its mean change at -1.08%

```{r echo=FALSE}
# Output summary of changes by year
yearly.change.pct.table
```

### Category correlation

Looking at the correlation between each of these categories with a correlation matrix, we can see that each of them is positively correlated. Violent crime has the lowest overall correlation with all of the other categories, while motor vehicle theft had the highest. The two with the highest correlation was vehicle theft and burglary at 0.77.

```{r echo=FALSE}
# Plot the correlations
corrplot(cor.matrix, method = 'number', type = 'lower', order = 'hclust')
```